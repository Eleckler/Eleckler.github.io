<!DOCTYPE html>
<html lang="en">
    <head>
  <!-- 元数据 -->
  <meta charset="utf-8">
  <link rel="icon" href="/images/thumb/zznnlogo.webp">
  
  <title>ubuntu部署kubernetes与ceph集成 | zznn</title>
  
  <meta name="author" content="zznn" />
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="robots" content="index,follow" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="format-detection" content="telphone=no, email=no" />
  
    <meta name="keywords" content="ceph, kubernetes, ubuntu" />
  
  <meta name="description" content="ubuntu部署kubernetes与ceph集成主要参考：https:&#x2F;&#x2F;skyao.io&#x2F;learning-kubernetes&#x2F;docs&#x2F;installation&#x2F;kubeadm&#x2F;ubuntu.htmlhttps:&#x2F;&#x2F;www.cnblogs.com&#x2F;way2backend&#x2F;p&#x2F;16970506.html#3-%E5%AE%89%E8%A3%85containerd 前言：系统最低要求  一.">
<meta property="og:type" content="article">
<meta property="og:title" content="ubuntu部署kubernetes与ceph集成">
<meta property="og:url" content="https://gegewu12.github.io/2023/06/04/ubuntu%E9%83%A8%E7%BD%B2kubernetes%E4%B8%8Eceph%E9%9B%86%E6%88%90/index.html">
<meta property="og:site_name" content="zznn">
<meta property="og:description" content="ubuntu部署kubernetes与ceph集成主要参考：https:&#x2F;&#x2F;skyao.io&#x2F;learning-kubernetes&#x2F;docs&#x2F;installation&#x2F;kubeadm&#x2F;ubuntu.htmlhttps:&#x2F;&#x2F;www.cnblogs.com&#x2F;way2backend&#x2F;p&#x2F;16970506.html#3-%E5%AE%89%E8%A3%85containerd 前言：系统最低要求  一.">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://gegewu12.github.io/images/thumb/zznnlogo.webp">
<meta property="article:published_time" content="2023-06-04T09:00:22.000Z">
<meta property="article:modified_time" content="2023-06-05T13:13:44.729Z">
<meta property="article:author" content="zznn">
<meta property="article:tag" content="ubuntu">
<meta property="article:tag" content="ceph">
<meta property="article:tag" content="kubernetes">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gegewu12.github.io/images/thumb/zznnlogo.webp">
  
  <!-- 站点验证相关 -->
  
    
    
    
  
  <!-- 样式表文件 -->
  <link rel="stylesheet" id="kratos-css" href="/css/kratosr.min.css" media="all"></script>
  
    <link rel="stylesheet" id="darkmode-css" href="/css/kr-color-dark.min.css" media="(prefers-color-scheme: dark)"></script>
    <script src="/js/kr-dark.min.js"></script>
  
  
    <link rel="stylesheet" id="highlight-css" href="/css/highlight/night-eighties.min.css" media="all"></script>
  
  <link rel="stylesheet" id="fontawe-css" href="/vendors/font-awesome@4.7.0/css/font-awesome.min.css" media="all"></script>
  <link rel="stylesheet" id="nprogress-css" href="/vendors/nprogress@0.2.0/nprogress.css" media="all"></script>
  
  
    <link rel="stylesheet" href="/vendors/aplayer@1.10.1/dist/APlayer.min.css"></script>
  
  
    <link rel="stylesheet" href="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"></script>
  
  <!-- 不得不预先加载的一些JS文件 -->
  <script src="/vendors/jquery@3.6.0/dist/jquery.min.js"></script>
  
    <script src="/vendors/qrcode_js@1.0.0/qrcode.min.js"></script>
  
  
  <style>
    
    
  </style>
  
<meta name="generator" content="Hexo 5.4.2"></head>


    <body class="custom-background">
        <div id="kratos-wrapper">
    <div id="kratos-page">
        <div id="kratos-header">
            <header id="kratos-desktop-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="nav-header">
                        <nav id="kratos-menu-wrap">
                            <ul id="kratos-primary-menu" class="sf-menu">
                                
                                    
                                        <li>
                                            
                                                <a href="/">
                                            
                                                
                                                    <i class="fa fa-home"></i>
                                                
                                                首页
                                            </a>
                                            
                                        </li>
                                    
                                        <li>
                                            
                                                <a href="/archives/">
                                            
                                                
                                                    <i class="fa fa-file"></i>
                                                
                                                档案馆
                                            </a>
                                            
                                        </li>
                                    
                                        <li>
                                            
                                                <a href="/friends/">
                                            
                                                
                                                    <i class="fa fa-paw"></i>
                                                
                                                好伙伴
                                            </a>
                                            
                                        </li>
                                    
                                        <li>
                                            
                                                <a>
                                            
                                                
                                                    <i class="fa fa-link"></i>
                                                
                                                链接
                                            </a>
                                            
                                                <ul class="sub-menu">
                                                    
                                                        <li>
                                                            <a target="_blank" rel="noopener" href="http://gegewu12.gitee.io">
                                                                
                                                                作者博客
                                                            </a>
                                                        </li>
                                                    
                                                        <li>
                                                            <a href="https://gegewu12.github.io/">
                                                                
                                                                GitHub博客
                                                            </a>
                                                        </li>
                                                    
                                                        <li>
                                                            <a target="_blank" rel="noopener" href="https://github.com/Candinya/Kratos-Rebirth">
                                                                
                                                                项目链接
                                                            </a>
                                                        </li>
                                                    
                                                        <li>
                                                            <a target="_blank" rel="noopener" href="https://fontawesome.com.cn/v4/icons">
                                                                
                                                                图标库
                                                            </a>
                                                        </li>
                                                    
                                                        <li>
                                                            <a target="_blank" rel="noopener" href="https://kr-demo.candinya.com/posts/Kratos-Rebirth-Manual/">
                                                                
                                                                Kratos-Rebirth
                                                            </a>
                                                        </li>
                                                    
                                                        <li>
                                                            <a target="_blank" rel="noopener" href="https://console-e1.leancloud.cn/login">
                                                                
                                                                leanCloud
                                                            </a>
                                                        </li>
                                                    
                                                </ul>
                                            
                                        </li>
                                    
                                        <li>
                                            
                                                <a href="https://gegewu12.github.io/2023/05/23/留言板/">
                                            
                                                
                                                    <i class="fa fa-paper-plane"></i>
                                                
                                                留言板
                                            </a>
                                            
                                        </li>
                                    
                                        <li>
                                            
                                                <a href="https://gegewu12.github.io/2023/05/22/关于/">
                                            
                                                
                                                    <i class="fa fa-heart"></i>
                                                
                                                关于
                                            </a>
                                            
                                        </li>
                                    
                                
                            </ul>
                        </nav>
                    </div>
                </div>
            </header>
            <header id="kratos-mobile-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="color-logo"><a href="/">zznn</a></div>
                    <div class="nav-toggle">
                        <a class="kratos-nav-toggle js-kratos-nav-toggle">
                            <i></i>
                        </a>
                    </div>
                </div>
            </header>
        </div>
        <div class="kratos-start kratos-hero-2">
            <!-- <div class="kratos-overlay"></div> -->
            <div class="kratos-cover kratos-cover-2 text-center">
                <div class="desc desc2 animate-box">
                    <a href="/">
                        <h2>zznn</h2> <br />
                        <span>平芜尽处是春山.</span>
                    </a>
                </div>
            </div>
        </div>

        <div id="kratos-blog-post">
            <div class="container">
                <div id="main" class="row">
                    

        

            <section class="col-md-8">

        

            <article itemscope itemtype="https://schema.org/Article">
    
    <link itemprop="mainEntityOfPage" href="https://gegewu12.github.io/2023/06/04/ubuntu%E9%83%A8%E7%BD%B2kubernetes%E4%B8%8Eceph%E9%9B%86%E6%88%90/">
    <div class="kratos-hentry kratos-post-inner clearfix">
        <header class="kratos-entry-header">
            
                <h1 class="kratos-entry-title text-center" itemprop="name headline">ubuntu部署kubernetes与ceph集成</h1>
            
            
            <ul class="kratos-post-meta text-center">
                <li><time datetime="2023-06-04T09:00:22.000Z" itemprop="datePublished"><i class="fa fa-calendar"></i> 2023-06-04</time></li>
                <li itemprop="author" itemscope itemtype="https://schema.org/Person">
                    <i class="fa fa-user"></i> 作者 <span itemprop="name">zznn</span>
                </li>
                
                    <li>
                        <i class="fa fa-edit"></i> 
                        
                        
                            ~16.10K
                        
                        字
                    </li>
                
                
                    <li id="/2023/06/04/ubuntu%E9%83%A8%E7%BD%B2kubernetes%E4%B8%8Eceph%E9%9B%86%E6%88%90/" class="leancloud_visitors" data-flag-title="ubuntu部署kubernetes与ceph集成">
                        <i class="fa fa-eye"></i>
                        <span class="leancloud-visitors-count"> </span> 次阅读
                    </li>
                
            </ul>
        </header>
        <div class="kratos-post-content">
            
            <div id="expire-alert" class="alert alert-warning hidden" role="alert">
                <div class="icon"><i class="fa fa-warning"></i></div>
                <div class="text"><p>本文最后编辑于 <time datetime="1685970824729"></time> 前，其中的内容可能需要更新。</p></div>
            </div>
            
            
            
                <div class="kratos-post-inner-toc toc-div-class" >
                    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#ubuntu%E9%83%A8%E7%BD%B2kubernetes%E4%B8%8Eceph%E9%9B%86%E6%88%90"><span class="toc-text">ubuntu部署kubernetes与ceph集成</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-text">一. 环境准备</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%85%88%E9%83%A8%E7%BD%B2%E5%A5%BDceph"><span class="toc-text">1.  先部署好ceph</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-ubuntu%E6%8D%A2%E9%98%BF%E9%87%8C%E4%BA%91kubernetes%E6%BA%90-%E5%AE%89%E8%A3%85k8s%E9%83%A8%E7%BD%B2%E5%B7%A5%E5%85%B7-%EF%BC%88%E6%AD%A4%E6%AD%A5%E9%AA%A4%E6%AD%A4%E5%A4%84%E4%B8%8D%E5%81%9A%EF%BC%89"><span class="toc-text">2. ubuntu换阿里云kubernetes源 安装k8s部署工具 （此步骤此处不做）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%B8%B8%E8%A7%84%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%EF%BC%88%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E6%89%A7%E8%A1%8C%EF%BC%89"><span class="toc-text">3. 常规环境配置（所有节点执行）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E5%AE%89%E8%A3%85-docker-containerd-%EF%BC%88-%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9-%EF%BC%89"><span class="toc-text">4.安装 docker containerd （ 所有节点 ）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E5%AE%89%E8%A3%85docker-ce"><span class="toc-text">5.安装docker-ce</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-%E5%AE%89%E8%A3%85containerd-%E6%AD%A4%E5%A4%84%E5%8F%AF%E4%B8%8D%E6%89%A7%E8%A1%8C%E5%8E%9F%E5%9B%A0%E4%BD%8E%E7%89%88%E6%9C%AC%E4%BB%8D%E7%94%A8docker"><span class="toc-text">6.安装containerd ( 此处可不执行原因低版本仍用docker )</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-%E5%AE%89%E8%A3%85Kubernetes%E7%BB%84%E4%BB%B6-%EF%BC%88-%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9-%EF%BC%89"><span class="toc-text">7. 安装Kubernetes组件 （ 所有节点 ）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C-%E5%88%9D%E5%A7%8B%E5%8C%96Master-ceph1-%E8%8A%82%E7%82%B9-%EF%BC%88-%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E5%BB%BA%E8%AE%AE%E4%BD%BF%E7%94%A82-%EF%BC%89"><span class="toc-text">二. 初始化Master(ceph1)节点 （ 所有节点建议使用2 ）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E4%BD%BF%E7%94%A8%E8%84%9A%E6%9C%AC%E6%8B%89%E5%8F%96%E5%90%8E%E5%86%8D%E6%AC%A1%E6%89%A7%E8%A1%8C%E5%88%9D%E5%A7%8B%E5%8C%96%E9%9B%86%E7%BE%A4"><span class="toc-text">1.使用脚本拉取后再次执行初始化集群</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%88%9D%E5%A7%8B%E5%8C%96%E9%9B%86%E7%BE%A4-%EF%BC%88%E9%83%A8%E7%BD%B2%E8%8A%82%E7%82%B9ceph1%E6%89%A7%E8%A1%8C%EF%BC%89%E7%9B%B4%E6%8E%A5%E6%8C%87%E5%AE%9A%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93%E5%88%9D%E5%A7%8B%E5%8C%96%E9%9B%86%E7%BE%A4"><span class="toc-text">2.初始化集群 （部署节点ceph1执行）直接指定镜像仓库初始化集群</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%85%B3%E4%BA%8E%E6%8A%A5%E9%94%99%E8%B6%85%E6%97%B6"><span class="toc-text">3.关于报错超时</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E6%8C%89%E7%85%A7%E6%8F%90%E7%A4%BA%E4%BF%A1%E6%81%AF%E7%BB%A7%E7%BB%AD%E5%88%9D%E5%A7%8B%E5%8C%96-ceph-1"><span class="toc-text">4.按照提示信息继续初始化(ceph-1)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89-%E6%B7%BB%E5%8A%A0%E5%85%B6%E4%BB%96%E8%8A%82%E7%82%B9"><span class="toc-text">三. 添加其他节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B-%E5%AE%89%E8%A3%85%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6-ceph-1"><span class="toc-text">四. 安装网络插件(ceph-1)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E9%87%87%E2%BD%A4flannel%E7%9A%84%E2%BD%B9%E7%BB%9C%E6%8F%92%E4%BB%B6"><span class="toc-text">1.采⽤flannel的⽹络插件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%AE%89%E8%A3%85flannel%E6%8F%92%E4%BB%B6%EF%BC%88node-1%EF%BC%89"><span class="toc-text">2.安装flannel插件（node-1）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E9%83%A8%E7%BD%B2%E9%9C%80%E8%A6%81%E6%8B%89%E5%8F%96%E9%95%9C%E5%83%8F%EF%BC%8C%E9%9C%80%E8%A6%81%E7%82%B9%E6%97%B6%E9%97%B4%EF%BC%8C%E5%8F%AF%E4%BB%A5%E6%9F%A5%E7%9C%8Bflannel%E9%83%A8%E7%BD%B2%E7%9A%84%E6%83%85%E5%86%B5"><span class="toc-text">3.部署需要拉取镜像，需要点时间，可以查看flannel部署的情况</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E9%83%A8%E7%BD%B2cni"><span class="toc-text">4.所有节点部署cni</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94-%E9%AA%8C%E8%AF%81%E9%9B%86%E7%BE%A4"><span class="toc-text">五. 验证集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94-%E5%8F%91%E5%B8%83%E7%AE%80%E5%8D%95nginx%E5%BA%94%E7%94%A8"><span class="toc-text">五.  发布简单nginx应用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AD-%E5%8F%91%E5%B8%83%E5%AE%9E%E7%8E%B0%E5%A4%96%E9%83%A8%E8%AE%BF%E9%97%AEnginx%E5%BA%94%E7%94%A8"><span class="toc-text">六. 发布实现外部访问nginx应用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%83-k8s%E5%89%8D%E7%AB%AF%E9%83%A8%E7%BD%B2-%EF%BC%88%E9%BB%98%E8%AE%A4%E6%B2%A1%E6%9C%89%E9%83%A8%E7%BD%B2%E4%B8%BA%E5%8F%AF%E9%80%89%E5%80%BC%EF%BC%89"><span class="toc-text">七. k8s前端部署 （默认没有部署为可选值）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AB-k8s%E4%B8%8Eceph%E9%9B%86%E6%88%90"><span class="toc-text">八. k8s与ceph集成</span></a></li></ol></li></ol>
                </div>
            
            <hr />
            <div itemprop="articleBody"><h2 id="ubuntu部署kubernetes与ceph集成"><a href="#ubuntu部署kubernetes与ceph集成" class="headerlink" title="ubuntu部署kubernetes与ceph集成"></a><code>ubuntu</code>部署<code>kubernetes</code>与<code>ceph</code>集成</h2><p>主要参考：<br><a target="_blank" rel="noopener" href="https://skyao.io/learning-kubernetes/docs/installation/kubeadm/ubuntu.html">https://skyao.io/learning-kubernetes/docs/installation/kubeadm/ubuntu.html</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/way2backend/p/16970506.html#3-%E5%AE%89%E8%A3%85containerd">https://www.cnblogs.com/way2backend/p/16970506.html#3-%E5%AE%89%E8%A3%85containerd</a></p>
<p>前言：系统最低要求</p>
<p><img src="/2023/06/04/ubuntu%E9%83%A8%E7%BD%B2kubernetes%E4%B8%8Eceph%E9%9B%86%E6%88%90/image-20230605111633768.png" alt="image-20230605111633768"></p>
<h3 id="一-环境准备"><a href="#一-环境准备" class="headerlink" title="一. 环境准备"></a>一. 环境准备</h3><p>ubuntu18.04</p>
<h4 id="1-先部署好ceph"><a href="#1-先部署好ceph" class="headerlink" title="1.  先部署好ceph"></a><code>1.</code>  先部署好<code>ceph</code></h4><p><img src="/2023/06/04/ubuntu%E9%83%A8%E7%BD%B2kubernetes%E4%B8%8Eceph%E9%9B%86%E6%88%90/image-20230605185208525.png" alt="image-20230605185208525"></p>
<h4 id="2-ubuntu换阿里云kubernetes源-安装k8s部署工具-（此步骤此处不做）"><a href="#2-ubuntu换阿里云kubernetes源-安装k8s部署工具-（此步骤此处不做）" class="headerlink" title="2. ubuntu换阿里云kubernetes源 安装k8s部署工具 （此步骤此处不做）"></a><code>2.</code> <code>ubuntu</code>换阿里云<code>kubernetes</code>源 安装<code>k8s</code>部署工具 （此步骤此处不做）</h4><p><a target="_blank" rel="noopener" href="https://developer.aliyun.com/mirror/kubernetes?spm=a2c6h.13651102.0.0.3a921b11eJ2T1U">https://developer.aliyun.com/mirror/kubernetes?spm=a2c6h.13651102.0.0.3a921b11eJ2T1U</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ubuntu换阿里云kubernetes源</span></span><br><span class="line">apt-get update &amp;&amp; apt-get install -y apt-transport-https</span><br><span class="line">curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add - </span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt;/etc/apt/sources.list.d/kubernetes.list</span></span><br><span class="line"><span class="string">deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<p><code>centos</code>则</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># `centos`换阿里云`kubernetes`源</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; /etc/yum.repos.d/kubernetes.repo</span></span><br><span class="line"><span class="string">[kubernetes]</span></span><br><span class="line"><span class="string">name=Kubernetes</span></span><br><span class="line"><span class="string">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=1</span></span><br><span class="line"><span class="string">repo_gpgcheck=1</span></span><br><span class="line"><span class="string">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">setenforce 0</span><br><span class="line">yum install -y kubelet kubeadm kubectl</span><br><span class="line">systemctl <span class="built_in">enable</span> kubelet &amp;&amp; systemctl start kubelet</span><br></pre></td></tr></table></figure>

<h4 id="3-常规环境配置（所有节点执行）"><a href="#3-常规环境配置（所有节点执行）" class="headerlink" title="3. 常规环境配置（所有节点执行）"></a><code>3</code>. 常规环境配置（所有节点执行）</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 框内所有节点执行 主机双网卡 文件位置： /etc/hosts （所有节点）</span></span><br><span class="line">10.0.0.10  ceph1  <span class="comment">#(10.0.0.138)</span></span><br><span class="line">10.0.0.11  ceph2  <span class="comment">#(10.0.0.139)</span></span><br><span class="line">10.0.0.12  ceph3  <span class="comment">#(10.0.0.140)</span></span><br><span class="line"><span class="comment"># 主机名：（所有节点）</span></span><br><span class="line">hostnamectl set-hostname ceph1</span><br><span class="line">hostnamectl set-hostname ceph2</span><br><span class="line">hostnamectl set-hostname ceph3</span><br><span class="line"><span class="comment"># centos关闭防火墙：（所有节点）</span></span><br><span class="line">systemctl stop firewalld &amp;&amp; systemctl <span class="built_in">disable</span> firewalld</span><br><span class="line"><span class="comment"># ubuntu关闭防火墙：（所有节点）</span></span><br><span class="line">systemctl stop ufw &amp;&amp; systemctl <span class="built_in">disable</span> ufw</span><br><span class="line"><span class="comment"># 关闭 selinux：</span></span><br><span class="line">sed -i <span class="string">&#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27;</span>   /etc/selinux/config  &amp;&amp; setenforce 0</span><br><span class="line">①.   配置无密码认证（ceph1）</span><br><span class="line">	<span class="comment">#拷贝公钥给对方包括自己</span></span><br><span class="line">	ssh-keygen</span><br><span class="line">	ssh-copy-id -i  /root/.ssh/id_rsa.pub ceph1</span><br><span class="line">	ssh-copy-id -i  /root/.ssh/id_rsa.pub ceph2    </span><br><span class="line">	ssh-copy-id -i  /root/.ssh/id_rsa.pub ceph3</span><br><span class="line">③.  执行如下命令，关闭swap</span><br><span class="line"><span class="comment"># 关闭swap 临时 永久 （所有节点）</span></span><br><span class="line">swapoff -a                              </span><br><span class="line">sed -ri <span class="string">&#x27;s/.*swap.*/#&amp;/&#x27;</span> /etc/fstab     </span><br><span class="line"><span class="built_in">cat</span> /etc/fstab </span><br><span class="line"><span class="comment"># 修改内核参数 载入如下内核模块 （所有节点）</span></span><br><span class="line">sudo <span class="built_in">tee</span> /etc/modules-load.d/containerd.conf &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">overlay</span></span><br><span class="line"><span class="string">br_netfilter</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">sudo modprobe overlay</span><br><span class="line">sudo modprobe br_netfilter</span><br><span class="line"><span class="comment"># 配置下面的网络参数：（所有节点）</span></span><br><span class="line">sudo <span class="built_in">tee</span> /etc/sysctl.d/kubernetes.conf &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward = 1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="comment"># 运行下面的command使改动生效：</span></span><br><span class="line">sudo sysctl --system</span><br></pre></td></tr></table></figure>

<h4 id="4-安装-docker-containerd-（-所有节点-）"><a href="#4-安装-docker-containerd-（-所有节点-）" class="headerlink" title="4.安装 docker containerd （ 所有节点 ）"></a><code>4</code>.安装<code> docker containerd</code> （ 所有节点 ）</h4><p>Docker，Kubernetes 等工具来运行一个容器时会调用组件（CRI）比如 containerd，CRI-O来来完成容器的创建、运行、销毁等实际工作。Docker 使用的是 containerd 作为其运行时；Kubernetes 支持 containerd，CRI-O等，这些组件都遵循了 OCI 规范，并通过 runc 来实现与操作系统内核交互来完成容器的创建和运行。</p>
<p>他们之间的相互关系如下：</p>
<img src="/2023/06/04/ubuntu%E9%83%A8%E7%BD%B2kubernetes%E4%B8%8Eceph%E9%9B%86%E6%88%90/20221211223351_45230.jpg" alt="image-20221209223024990" style="zoom: 50%;">

<h4 id="5-安装docker-ce"><a href="#5-安装docker-ce" class="headerlink" title="5.安装docker-ce"></a><code>5.</code>安装<code>docker-ce</code></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># step 1: 安装必要的一些系统工具</span></span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get -y install apt-transport-https ca-certificates curl software-properties-common</span><br><span class="line"><span class="comment"># step 2: 安装GPG证书</span></span><br><span class="line">curl -fsSL https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -</span><br><span class="line"><span class="comment"># Step 3: 写入软件源信息</span></span><br><span class="line">sudo add-apt-repository <span class="string">&quot;deb [arch=amd64] https://mirrors.aliyun.com/docker-ce/linux/ubuntu <span class="subst">$(lsb_release -cs)</span> stable&quot;</span></span><br><span class="line"><span class="comment"># Step 4: 更新并安装Docker-CE</span></span><br><span class="line">sudo apt-get -y update</span><br><span class="line">sudo apt-get -y install docker-ce</span><br><span class="line">sudo apt-get install docker-ce=18.06.3~ce~3-0~ubuntu -y</span><br><span class="line"><span class="comment"># ubuntu20.04则安装</span></span><br><span class="line">sudo apt-get install docker-ce=5:19.03.9~3-0~ubuntu-focal</span><br><span class="line"><span class="comment"># 安装指定版本的Docker-CE:</span></span><br><span class="line"><span class="comment"># Step 1: 查找Docker-CE的版本:</span></span><br><span class="line"><span class="comment"># apt-cache madison docker-ce</span></span><br><span class="line"><span class="comment">#   docker-ce | 17.03.1~ce-0~ubuntu-xenial | https://mirrors.aliyun.com/docker-ce/linux/ubuntu xenial/stable amd64 Packages</span></span><br><span class="line"><span class="comment">#   docker-ce | 17.03.0~ce-0~ubuntu-xenial | https://mirrors.aliyun.com/docker-ce/linux/ubuntu xenial/stable amd64 Packages</span></span><br><span class="line"><span class="comment"># Step 2: 安装指定版本的Docker-CE: (VERSION例如上面的17.03.1~ce-0~ubuntu-xenial)</span></span><br><span class="line"><span class="comment"># sudo apt-get -y install docker-ce=[VERSION]</span></span><br><span class="line"><span class="comment"># 设置systemd</span></span><br><span class="line">sudo vi /etc/docker/daemon.json</span><br><span class="line">增加内容：</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;exec-opts&quot;</span>: [<span class="string">&quot;native.cgroupdriver=systemd&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line">或</span><br><span class="line"><span class="built_in">mkdir</span> /etc/docker </span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | sudo tee /etc/docker/daemon.json </span></span><br><span class="line"><span class="string">&#123; </span></span><br><span class="line"><span class="string">&quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;], </span></span><br><span class="line"><span class="string">&quot;log-driver&quot;: &quot;json-file&quot;, </span></span><br><span class="line"><span class="string">&quot;log-opts&quot;: &#123; </span></span><br><span class="line"><span class="string">&quot;max-size&quot;: &quot;100m&quot; </span></span><br><span class="line"><span class="string">&#125;, </span></span><br><span class="line"><span class="string">&quot;storage-driver&quot;: &quot;overlay2&quot; </span></span><br><span class="line"><span class="string">&#125; </span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">修改完成后重启 docker：</span><br><span class="line">systemctl restart docker</span><br><span class="line"><span class="comment"># 重启后检查一下</span></span><br><span class="line">docker info | grep <span class="string">&quot;Cgroup Driver&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="6-安装containerd-此处可不执行原因低版本仍用docker"><a href="#6-安装containerd-此处可不执行原因低版本仍用docker" class="headerlink" title="6.安装containerd ( 此处可不执行原因低版本仍用docker )"></a><code>6.</code>安装<code>containerd</code> ( 此处可不执行原因低版本仍用<code>docker</code> )</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装dependencies：</span></span><br><span class="line">sudo apt install -y curl gnupg2 software-properties-common apt-transport-https ca-certificates</span><br><span class="line"><span class="comment"># 添加docker repo：</span></span><br><span class="line">sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmour -o /etc/apt/trusted.gpg.d/docker.gpg</span><br><span class="line">sudo add-apt-repository <span class="string">&quot;deb [arch=amd64] https://download.docker.com/linux/ubuntu <span class="subst">$(lsb_release -cs)</span> stable&quot;</span></span><br><span class="line"><span class="comment"># 安装containerd</span></span><br><span class="line">sudo apt update</span><br><span class="line">sudo apt install -y containerd.io</span><br><span class="line"><span class="comment"># 配置containerd使用systemd作为cgroup</span></span><br><span class="line">containerd config default | sudo <span class="built_in">tee</span> /etc/containerd/config.toml &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">sudo sed -i <span class="string">&#x27;s/SystemdCgroup \= false/SystemdCgroup \= true/g&#x27;</span> /etc/containerd/config.toml</span><br><span class="line"><span class="comment"># 重启并设置开机自启</span></span><br><span class="line">sudo systemctl restart containerd</span><br><span class="line">sudo systemctl <span class="built_in">enable</span>  containerd</span><br></pre></td></tr></table></figure>

<h4 id="7-安装Kubernetes组件-（-所有节点-）"><a href="#7-安装Kubernetes组件-（-所有节点-）" class="headerlink" title="7. 安装Kubernetes组件 （ 所有节点 ）"></a><code>7</code>. 安装<code>Kubernetes</code>组件 （ 所有节点 ）</h4><p>添加<code>ubuntu</code>源 （阿里 谷歌选其一）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># google 源</span></span><br><span class="line">curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -</span><br><span class="line">sudo apt-add-repository <span class="string">&quot;deb http://apt.kubernetes.io/ kubernetes-xenial main&quot;</span></span><br><span class="line"><span class="comment"># 阿里源</span></span><br><span class="line">apt-get update &amp;&amp; apt-get install -y apt-transport-https</span><br><span class="line">curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add - </span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt;/etc/apt/sources.list.d/kubernetes.list</span></span><br><span class="line"><span class="string">deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">apt update</span><br></pre></td></tr></table></figure>

<p>安装<code>kubelet=1.23.6-00  kubeadm=1.23.6-00  kubectl=1.23.6-00</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 选择版本安装</span></span><br><span class="line">apt-cache madison kubelet</span><br><span class="line"><span class="comment"># 安装Kubectl, kubeadm &amp; kubelet 此处安装1.26.0不指定版本将会安装最新版</span></span><br><span class="line">sudo apt update</span><br><span class="line"><span class="comment"># kubelet=1.23.6-00  kubeadm=1.23.6-00  kubectl=1.23.6-00 </span></span><br><span class="line">sudo apt install -y kubelet=1.23.6-00  kubeadm=1.23.6-00  kubectl=1.23.6-00 </span><br><span class="line">sudo apt-mark hold  kubelet=1.23.6-00  kubeadm=1.23.6-00  kubectl=1.23.6-00 </span><br><span class="line"><span class="comment"># 取消保留</span></span><br><span class="line">sudo apt-mark unhold kubelet=1.26.0-00 kubeadm=1.26.0-00 kubectl=1.26.0-00</span><br><span class="line"><span class="comment"># 卸载</span></span><br><span class="line">dpkg -l |grep kubele  |awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> |xargs apt remove -y</span><br><span class="line">dpkg -l |grep kubeadm |awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> |xargs apt remove -y</span><br><span class="line">dpkg -l |grep kubectl |awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> |xargs apt remove -y</span><br></pre></td></tr></table></figure>

<p>apt-mark 用于将软件包标记/取消标记为自动安装。 hold 选项用于将软件包标记为保留，以防止软件包被自动安装、升级或删除。这里主要是为了防止kubelet等组件自动升级。<img src="/2023/06/04/ubuntu%E9%83%A8%E7%BD%B2kubernetes%E4%B8%8Eceph%E9%9B%86%E6%88%90/image-20230605103550516.png" alt="image-20230605103550516"></p>
<h3 id="二-初始化Master-ceph1-节点-（-所有节点建议使用2-）"><a href="#二-初始化Master-ceph1-节点-（-所有节点建议使用2-）" class="headerlink" title="二. 初始化Master(ceph1)节点 （ 所有节点建议使用2 ）"></a>二. 初始化<code>Master(ceph1)</code>节点 （ 所有节点建议使用<code>2</code> ）</h3><p>这步需要在Master节点进行设置，运行如下的节点初始化整个k8s集群。</p>
<h4 id="1-使用脚本拉取后再次执行初始化集群"><a href="#1-使用脚本拉取后再次执行初始化集群" class="headerlink" title="1.使用脚本拉取后再次执行初始化集群"></a><code>1.</code>使用脚本拉取后再次执行初始化集群</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line">aliyuns=<span class="string">&quot;registry.aliyuncs.com/google_containers&quot;</span></span><br><span class="line"><span class="comment">#&quot;registry.k8s.io&quot; &quot;k8s.gcr.io&quot;此处根据kubeadm config images list返回值填写</span></span><br><span class="line">google=`kubeadm config images list |awk -F<span class="string">&#x27;[ /]+&#x27;</span>  <span class="string">&#x27;NR==1&#123;print $1&#125;&#x27;</span>`</span><br><span class="line">image_list=`kubeadm config images list | awk -F <span class="string">&quot;/&quot;</span> <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>`</span><br><span class="line"><span class="keyword">for</span> image <span class="keyword">in</span> <span class="variable">$&#123;image_list&#125;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"> docker image pull <span class="variable">$&#123;aliyuns&#125;</span>/<span class="variable">$&#123;image&#125;</span></span><br><span class="line"> docker image tag <span class="variable">$&#123;aliyuns&#125;</span>/<span class="variable">$&#123;image&#125;</span> <span class="variable">$&#123;google&#125;</span>/<span class="variable">$&#123;image&#125;</span></span><br><span class="line"> docker image <span class="built_in">rm</span> <span class="variable">$&#123;aliyuns&#125;</span>/<span class="variable">$&#123;image&#125;</span></span><br><span class="line"> <span class="built_in">echo</span> -e <span class="string">&quot;\033[32m <span class="variable">$&#123;google&#125;</span>/<span class="variable">$&#123;image&#125;</span> download.\033[0m&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>脚本解析</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看k8s镜像</span></span><br><span class="line">kubeadm config images list</span><br><span class="line"><span class="comment"># pull</span></span><br><span class="line">docker pull registry.aliyuncs.com/google_containers/coredns:v1.9.3</span><br><span class="line"><span class="comment"># 删除所有镜像</span></span><br><span class="line">docker rmi $(docker images -q) &amp;&amp; docker images |awk <span class="string">&#x27;&#123;print $3&#125;&#x27;</span> |xargs docker rmi -f</span><br><span class="line"><span class="comment"># 改名及指定tag删除镜像实际执行</span></span><br><span class="line">docker tag registry.aliyuncs.com/google_containers/coredns:v1.9.3 registry.k8s.io/coredns:v1.9.3</span><br><span class="line">docker image <span class="built_in">rm</span> registry.aliyuncs.com/google_containers/coredns:v1.9.3</span><br><span class="line"><span class="comment"># 删除改名前的镜像</span></span><br><span class="line">docker images |grep k8s.gcr.io |awk <span class="string">&#x27;&#123;print $1&quot;:&quot;$2&#125;&#x27;</span> |xargs docker image <span class="built_in">rm</span> </span><br></pre></td></tr></table></figure>

<h4 id="2-初始化集群-（部署节点ceph1执行）直接指定镜像仓库初始化集群"><a href="#2-初始化集群-（部署节点ceph1执行）直接指定镜像仓库初始化集群" class="headerlink" title="2.初始化集群 （部署节点ceph1执行）直接指定镜像仓库初始化集群"></a><code>2.</code>初始化集群 （部署节点<code>ceph1</code>执行）直接指定镜像仓库初始化集群</h4><p>参考：sudo kubeadm init –control-plane-endpoint=192.168.31.200</p>
<p>通过kubeadm init初始化集群<br>常参数：<br>–apiserver-advertise-address      apiserver的地址，默认会选择访问外⽹的地址<br>–apiserver-bind-port                    apiserver访问端⼝，默认为6443<br>–image-repository registry.aliyuncs.com/google_containers  国内⽆法访问gcr.io仓库，指定阿⾥云仓库，⽆须翻墙【可选】<br>–pod-network-cidr       指定pod段访问的地址段，根据⽹络插件的不同（可以根据需要修改）<br>–kubernetes-version   默认是一个稳定的版本可以在这里 指定一个版本和kubeadm保持一致 默认会去拉最新的</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 清空集群</span></span><br><span class="line">kubeadm reset</span><br><span class="line"><span class="comment"># 查看kubeadm版本命令</span></span><br><span class="line">kubeadm version</span><br><span class="line"><span class="comment"># 进行集群的初始化 （google仓库在国外 国内不开代理无法访问 将源指向阿里的源  </span></span><br><span class="line">kubeadm init --image-repository=registry.aliyuncs.com/google_containers \</span><br><span class="line">--kubernetes-version=v1.23.6 \</span><br><span class="line">--apiserver-advertise-address=10.0.0.10 \</span><br><span class="line">--apiserver-bind-port=6443 \</span><br><span class="line">--pod-network-cidr=172.16.0.0/16 </span><br><span class="line"><span class="comment"># 初始化完成后保存完成时提示的信息</span></span><br></pre></td></tr></table></figure>

<p><img src="/2023/06/04/ubuntu%E9%83%A8%E7%BD%B2kubernetes%E4%B8%8Eceph%E9%9B%86%E6%88%90/image-20230605190100069.png" alt="image-20230605190100069"></p>
<h4 id="3-关于报错超时"><a href="#3-关于报错超时" class="headerlink" title="3.关于报错超时"></a><code>3.</code>关于报错超时</h4><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_46601322/article/details/126722529">https://blog.csdn.net/weixin_46601322/article/details/126722529</a><br>现象<br>[kubelet-check] Initial timeout of 40s passed<br>原因 k8s弃用docker改用containerd</p>
<p><img src="/2023/06/04/ubuntu%E9%83%A8%E7%BD%B2kubernetes%E4%B8%8Eceph%E9%9B%86%E6%88%90/image-20230605115254712.png" alt="image-20230605115254712"></p>
<p>解决 卸载高版本k8s切换到1.24以下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 选择版本安装</span></span><br><span class="line">apt-cache madison kubelet</span><br><span class="line"><span class="comment"># 安装Kubectl, kubeadm &amp; kubelet 此处安装1.23.6不指定版本将会安装最新版</span></span><br><span class="line"><span class="comment"># 卸载</span></span><br><span class="line">dpkg -l |grep kubele  |awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> |xargs apt remove -y</span><br><span class="line">dpkg -l |grep kubeadm |awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> |xargs apt remove -y</span><br><span class="line">dpkg -l |grep kubectl |awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> |xargs apt remove -y</span><br><span class="line"><span class="comment"># kubelet=1.23.6-00  kubeadm=1.23.6-00  kubectl=1.23.6-00 </span></span><br><span class="line">sudo apt install -y kubelet=1.23.6-00  kubeadm=1.23.6-00  kubectl=1.23.6-00 </span><br><span class="line">sudo apt-mark hold  kubelet=1.23.6-00  kubeadm=1.23.6-00  kubectl=1.23.6-00 </span><br></pre></td></tr></table></figure>

<h4 id="4-按照提示信息继续初始化-ceph-1"><a href="#4-按照提示信息继续初始化-ceph-1" class="headerlink" title="4.按照提示信息继续初始化(ceph-1)"></a><code>4.</code>按照提示信息继续初始化(<code>ceph-1</code>)</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 接着按照提示信息，进行后续的初始化工作：</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"><span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line"><span class="comment"># 上方初始化完成后即可使用k8s命令</span></span><br><span class="line">root@ceph-1:~<span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME     STATUS     ROLES                  AGE   VERSION</span><br><span class="line">ceph-1   NotReady   control-plane,master   4m    v1.23.6 </span><br></pre></td></tr></table></figure>

<h3 id="三-添加其他节点"><a href="#三-添加其他节点" class="headerlink" title="三. 添加其他节点"></a>三. 添加其他节点</h3><p>添加ceph节点<br>添加ceph节点，在ceph-2⾄ceph-3上执⾏添加节点动作（cluster节点 ceph-1不需要执行）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 保存初始化完成时的信息</span></span><br><span class="line">kubeadm <span class="built_in">join</span> 10.0.0.10:6443 --token syzgpw.kr096ii0ni5i7ccv \</span><br><span class="line">--discovery-token-ca-cert-hash sha256:90b0ea51ca2b5a8afe3b9019da14674c8c64594d6113f90af4cbce3970ca695b</span><br></pre></td></tr></table></figure>

<p>添加<code>ceph-2 ceph-3</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ssh到ceph-2</span></span><br><span class="line">ssh ceph-2</span><br><span class="line"><span class="comment"># 执行</span></span><br><span class="line">kubeadm <span class="built_in">join</span> 10.0.0.10:6443 --token syzgpw.kr096ii0ni5i7ccv \</span><br><span class="line">--discovery-token-ca-cert-hash sha256:90b0ea51ca2b5a8afe3b9019da14674c8c64594d6113f90af4cbce3970ca695b</span><br><span class="line"><span class="comment"># ssh到ceph-3</span></span><br><span class="line">ssh ceph-3</span><br><span class="line"><span class="comment"># 执行</span></span><br><span class="line">kubeadm <span class="built_in">join</span> 10.0.0.10:6443 --token syzgpw.kr096ii0ni5i7ccv \</span><br><span class="line">--discovery-token-ca-cert-hash sha256:90b0ea51ca2b5a8afe3b9019da14674c8c64594d6113f90af4cbce3970ca695b</span><br></pre></td></tr></table></figure>

<p>添加完成截图</p>
<p><img src="/2023/06/04/ubuntu%E9%83%A8%E7%BD%B2kubernetes%E4%B8%8Eceph%E9%9B%86%E6%88%90/image-20230605191010791.png" alt="image-20230605191010791"></p>
<p><img src="/2023/06/04/ubuntu%E9%83%A8%E7%BD%B2kubernetes%E4%B8%8Eceph%E9%9B%86%E6%88%90/image-20230605191402300.png" alt="image-20230605191402300"></p>
<p>查看节点是否都加进来了(<code>master</code>节点<code>ceph-1</code>执行)</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 对应版本是v1.23.6</span></span><br><span class="line">kubectl get nodes</span><br><span class="line">注：需要保证下载的版本和下载的镜像版本保持一致 不一致的化初始化时可能会出现异常</span><br></pre></td></tr></table></figure>

<p>添加成功</p>
<p><img src="/2023/06/04/ubuntu%E9%83%A8%E7%BD%B2kubernetes%E4%B8%8Eceph%E9%9B%86%E6%88%90/image-20230605191323210.png" alt="image-20230605191323210"></p>
<h3 id="四-安装网络插件-ceph-1"><a href="#四-安装网络插件-ceph-1" class="headerlink" title="四. 安装网络插件(ceph-1)"></a>四. 安装网络插件(<code>ceph-1</code>)</h3><p><img src="/2023/06/04/ubuntu%E9%83%A8%E7%BD%B2kubernetes%E4%B8%8Eceph%E9%9B%86%E6%88%90/image-20230605191516754.png" alt="image-20230605191516754"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@ceph-1:~<span class="comment"># kubectl get pods -n kube-system</span></span><br><span class="line">NAME                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-6d8c4cb4d-jcr7c          0/1     Pending   0          24m</span><br><span class="line">coredns-6d8c4cb4d-rhvkq          0/1     Pending   0          24m</span><br><span class="line">etcd-ceph-1                      1/1     Running   0          24m</span><br><span class="line">kube-apiserver-ceph-1            1/1     Running   0          24m</span><br><span class="line">kube-controller-manager-ceph-1   1/1     Running   0          24m</span><br><span class="line">kube-proxy-2zxxp                 1/1     Running   0          13m</span><br><span class="line">kube-proxy-klcbw                 1/1     Running   0          24m</span><br><span class="line">kube-proxy-z5988                 1/1     Running   0          11m</span><br><span class="line">kube-scheduler-ceph-1            1/1     Running   0          24m</span><br></pre></td></tr></table></figure>

<p>kubernetes⽀持多种⽹络插件，符合CNI标准，常⻅包括：<br>flannel   (自建居多)<br>calico  （bgp）<br>cilium<br>⽹络插件参考连接 ：<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/cluster-administration/networking/">https://kubernetes.io/docs/concepts/cluster-administration/networking/</a><br>(可以下载的话建议下载即可用:<br><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml">https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml</a><br>此链接为最新链接尚未测试)</p>
<p><a target="_blank" rel="noopener" href="https://github.com/containernetworking/plugins/releases/tag/v0.8.6">https://github.com/containernetworking/plugins/releases/tag/v0.8.6</a>  (cni下载地址)</p>
<h4 id="1-采⽤flannel的⽹络插件"><a href="#1-采⽤flannel的⽹络插件" class="headerlink" title="1.采⽤flannel的⽹络插件"></a><code>1.</code>采⽤flannel的⽹络插件</h4><p>github连接默认⽆法下载，使⽤如下内容，修改Network为<br>172.16.0.0/16（默认10.244.0.0/16），保存为kube-flannel.yaml<br>文件需要设置的地方：（设置为初始化时设置的IP段）</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># lencould链接</span></span><br><span class="line"><span class="string">http://lc-j2rHZR7P.cn-e1.lcfile.com/K27zS9tCtMdWLPk4CgsYC01OpBRe1Vrm/kube-flannel.yaml</span></span><br><span class="line"><span class="string">https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span></span><br><span class="line"><span class="attr">net-conf.json:</span> <span class="string">|</span></span><br><span class="line"><span class="string">   &#123;</span></span><br><span class="line"><span class="string">     &quot;Network&quot;: &quot;10.244.0.0/16&quot;,</span></span><br><span class="line"><span class="string">     &quot;Backend&quot;: &#123;</span></span><br><span class="line"><span class="string">       &quot;Type&quot;: &quot;vxlan&quot;</span></span><br><span class="line"><span class="string">     &#125;</span></span><br><span class="line"><span class="string">   &#125;</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<h4 id="2-安装flannel插件（node-1）"><a href="#2-安装flannel插件（node-1）" class="headerlink" title="2.安装flannel插件（node-1）"></a><code>2.</code>安装<code>flannel</code>插件（<code>node-1</code>）</h4> <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将文件apply一下(此时创建了许多角色)</span></span><br><span class="line">wget http://lc-j2rHZR7P.cn-e1.lcfile.com/K27zS9tCtMdWLPk4CgsYC01OpBRe1Vrm/kube-flannel.yaml</span><br><span class="line">kubectl apply -f kube-flannel.yaml</span><br></pre></td></tr></table></figure>

<p><img src="/2023/06/04/ubuntu%E9%83%A8%E7%BD%B2kubernetes%E4%B8%8Eceph%E9%9B%86%E6%88%90/image-20230605192555306.png" alt="image-20230605192555306"></p>
<h4 id="3-部署需要拉取镜像，需要点时间，可以查看flannel部署的情况"><a href="#3-部署需要拉取镜像，需要点时间，可以查看flannel部署的情况" class="headerlink" title="3.部署需要拉取镜像，需要点时间，可以查看flannel部署的情况"></a><code>3.</code>部署需要拉取镜像，需要点时间，可以查看<code>flannel</code>部署的情况</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看组件状态（可以看到每个node节点多了一些flannel  running说明网络组件安装起来可以运行了）</span></span><br><span class="line">kubectl get pods -n kube-system -o wide </span><br><span class="line">kube-flannel-ds-lnpkz            1/1     Running   0          2m9s   10.0.0.12   ceph-3   &lt;none&gt;     </span><br><span class="line">kube-flannel-ds-qr62m            1/1     Running   0          2m9s   10.0.0.11   ceph-2   &lt;none&gt;     </span><br><span class="line">kube-flannel-ds-vrqf8            1/1     Running   0          2m9s   10.0.0.10   ceph-1   &lt;none&gt;  </span><br><span class="line"><span class="comment"># 查看镜像详细信息</span></span><br><span class="line"><span class="comment"># kubectl describe pods kube-flannel-ds-8hhn6OrOEA -n kube-system </span></span><br><span class="line"><span class="comment"># 如果拉取失败可以手动拉取一下 还拉不下则export手动导一下</span></span><br><span class="line"><span class="comment"># docker image pull quay.io/coreos/flannel:v0.13.1-rcl</span></span><br><span class="line">==============</span><br><span class="line"><span class="comment">#查看节点状态还是没有变为ready 解决见（4.所有节点部署cni）</span></span><br><span class="line">kubectl get nodes</span><br><span class="line"><span class="comment">#查看日志命令</span></span><br><span class="line">journalctl -u kubelet -f </span><br></pre></td></tr></table></figure>

<h4 id="4-所有节点部署cni"><a href="#4-所有节点部署cni" class="headerlink" title="4.所有节点部署cni"></a><code>4.</code>所有节点部署<code>cni</code></h4><p>每个节点都需要执行：需要下载CNI插件：CNI plugins v0.8.6<br>github下载地址：<a target="_blank" rel="noopener" href="https://github.com/containernetworking/plugins/releases/tag/v0.8.6">https://github.com/containernetworking/plugins/releases/tag/v0.8.6</a> (在1.0.0版本后CNI Plugins中没有flannel) 下载后通过xftp 上传到Linux /home目录解压</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载</span></span><br><span class="line">wget http://lc-j2rHZR7P.cn-e1.lcfile.com/gPtRx5L5DkGO0FFoNRXoXbQUQpyL5Llr/cni-plugins-linux-amd64-v0.8.6.tgz</span><br><span class="line"><span class="comment"># 解压</span></span><br><span class="line">tar zxvf cni-plugins-linux-amd64-v0.8.6.tgz</span><br><span class="line"><span class="comment">#复制 flannel 到 /opt/cni/bin/</span></span><br><span class="line">[root@k8s-node1 home]<span class="comment"># cp flannel /opt/cni/bin/</span></span><br><span class="line"><span class="comment">#查看节点状态</span></span><br><span class="line">kubectl get nodes</span><br><span class="line"><span class="comment"># 等待五六分钟：…查看到状态立马变为Ready，至此解决问题。</span></span><br></pre></td></tr></table></figure>

<p><img src="/2023/06/04/ubuntu%E9%83%A8%E7%BD%B2kubernetes%E4%B8%8Eceph%E9%9B%86%E6%88%90/image-20230605195857743.png" alt="image-20230605195857743"></p>
<p><img src="/2023/06/04/ubuntu%E9%83%A8%E7%BD%B2kubernetes%E4%B8%8Eceph%E9%9B%86%E6%88%90/image-20230605200550753.png" alt="image-20230605200550753"></p>
<h3 id="五-验证集群"><a href="#五-验证集群" class="headerlink" title="五. 验证集群"></a>五. 验证集群</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 验证集群状态 </span></span><br><span class="line">kubectl get cs</span><br><span class="line">可以看到集群 集群状态时unhealthy 时因为cs这个接口在v1.19版本时已经废弃</span><br><span class="line">可以看到接⼝当前已经从1.19废弃。 </span><br><span class="line"><span class="comment"># 查看pods状态，均部署在kube-system这个namespace</span></span><br><span class="line">kubectl get pods -n kube-system</span><br><span class="line"><span class="comment"># 会在每一个节点上部署一个 kube-flannel-ds-p7fpw 和一个 kube-proxy-86fkk 加一个参数</span></span><br><span class="line">kubectl get pods -n kube-system -o wide </span><br><span class="line"><span class="comment"># 可以看到组件所在的对应节点</span></span><br><span class="line"><span class="comment"># coredns组件用于做名称解析</span></span><br><span class="line"><span class="comment"># 主要是通过daemonsets.apps的形式在里面部署两个daemonset分别是kube-flannel-ds 和 kube-proxy</span></span><br><span class="line">kubectl get daemonsets.apps -n kube-system</span><br><span class="line"><span class="comment"># 也会有对应的service这个service是专门用来调用dns的</span></span><br><span class="line">kubectl get services -n kube-system  </span><br><span class="line"><span class="comment"># 查看详细</span></span><br><span class="line">kubectl describe pods coredns-7f89b7bc75-lcnhg -n kube-system </span><br><span class="line"><span class="comment"># 删除pod</span></span><br><span class="line">kubectl delete deployment demo </span><br><span class="line">…</span><br><span class="line">deployment.apps <span class="string">&quot;demo&quot;</span> deleted</span><br><span class="line">…</span><br></pre></td></tr></table></figure>

<p><img src="/2023/06/04/ubuntu%E9%83%A8%E7%BD%B2kubernetes%E4%B8%8Eceph%E9%9B%86%E6%88%90/image-20230605200755751.png" alt="image-20230605200755751"></p>
<p><img src="/2023/06/04/ubuntu%E9%83%A8%E7%BD%B2kubernetes%E4%B8%8Eceph%E9%9B%86%E6%88%90/image-20230605200833123.png" alt="image-20230605200833123"></p>
<p><img src="/2023/06/04/ubuntu%E9%83%A8%E7%BD%B2kubernetes%E4%B8%8Eceph%E9%9B%86%E6%88%90/image-20230605200848493.png" alt="image-20230605200848493"></p>
<p><img src="/2023/06/04/ubuntu%E9%83%A8%E7%BD%B2kubernetes%E4%B8%8Eceph%E9%9B%86%E6%88%90/image-20230605200937574.png" alt="image-20230605200937574"></p>
<h3 id="五-发布简单nginx应用"><a href="#五-发布简单nginx应用" class="headerlink" title="五.  发布简单nginx应用"></a>五.  发布简单<code>nginx</code>应用</h3><p>此时我们的k8s集群已是正常的了 怎样验证呢：发布一个应用即可</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看帮助命令</span></span><br><span class="line">kubectl create deployment --<span class="built_in">help</span></span><br><span class="line"><span class="comment"># 开始发布应用</span></span><br><span class="line">kubectl create deployment demo --image=nginx:1.7.9 --replicas=3</span><br><span class="line">注：指定名称是demo 镜像是nginx:1.7.9 副本数是3</span><br><span class="line"><span class="comment"># 查看应用是否创建成功 可以看到名称 副本数等</span></span><br><span class="line">kubectl get deployments.apps </span><br><span class="line"><span class="comment"># 查看发布此应用是部署的容器</span></span><br><span class="line">kubectl get pods</span><br><span class="line"><span class="comment"># 想要看它正在做什么用describe (若拉取失败则此时需要手动拉取)</span></span><br><span class="line">kubectl describe pods demo-555566bddd-whhkp -n kube-system </span><br><span class="line">docker pull nginx:1.7.9</span><br><span class="line">截图：指定名称 指定副本数 等</span><br><span class="line"><span class="comment"># 删除pod</span></span><br><span class="line">kubectl delete deployment demo </span><br><span class="line">…</span><br><span class="line">deployment.apps <span class="string">&quot;demo&quot;</span> deleted</span><br><span class="line">…</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看详细</span></span><br><span class="line">kubectl get pods -o wide</span><br><span class="line">kubectl describe pods demo-5897d56b5b-glhj</span><br><span class="line"><span class="comment"># 查看demo应用（容器）service详细</span></span><br><span class="line">kubectl describe service demo</span><br></pre></td></tr></table></figure>

<p><img src="/2023/06/04/ubuntu%E9%83%A8%E7%BD%B2kubernetes%E4%B8%8Eceph%E9%9B%86%E6%88%90/image-20230605202137220.png" alt="image-20230605202137220"></p>
<p>应用发布成功</p>
<p><img src="/2023/06/04/ubuntu%E9%83%A8%E7%BD%B2kubernetes%E4%B8%8Eceph%E9%9B%86%E6%88%90/image-20230605201317297-16859672270351.png" alt="image-20230605201317297"></p>
<p>访问 （curl 172.16.1.2:80）</p>
<p><img src="/2023/06/04/ubuntu%E9%83%A8%E7%BD%B2kubernetes%E4%B8%8Eceph%E9%9B%86%E6%88%90/image-20230605201551896.png" alt="image-20230605201551896"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">①.创建集群内部访问的VIP</span><br><span class="line"><span class="comment">#创建service暴露端口使用vip访问</span></span><br><span class="line">kubectl expose deployment demo --port=80 --target-port=80 </span><br><span class="line">----------------------</span><br><span class="line">返回</span><br><span class="line">service/demo exposed</span><br><span class="line"><span class="comment">#查看service的vip</span></span><br><span class="line">kubectl get services</span><br><span class="line">返回</span><br><span class="line">NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">demo         ClusterIP   10.102.203.127   &lt;none&gt;        80/TCP    43s</span><br><span class="line">kubernetes   ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP   78m</span><br><span class="line"><span class="comment"># 此时通过这个IP访问nginx</span></span><br><span class="line">curl 10.102.203.127</span><br></pre></td></tr></table></figure>

<p><img src="/2023/06/04/ubuntu%E9%83%A8%E7%BD%B2kubernetes%E4%B8%8Eceph%E9%9B%86%E6%88%90/image-20230605201721352.png" alt="image-20230605201721352"></p>
<h3 id="六-发布实现外部访问nginx应用"><a href="#六-发布实现外部访问nginx应用" class="headerlink" title="六. 发布实现外部访问nginx应用"></a>六. 发布实现外部访问<code>nginx</code>应用</h3><p>nginx-deployment.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.7.9</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p>创建应用</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建应用</span></span><br><span class="line">kubectl apply -f nginx-deployment.yml</span><br><span class="line"><span class="comment"># 查看pods</span></span><br><span class="line">kubectl get pods</span><br></pre></td></tr></table></figure>

<p>创建 service, 并让外部访问</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-service</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">88</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br></pre></td></tr></table></figure>

<p>创建<code>service</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建service </span></span><br><span class="line">kubectl create -f nginx-service.yaml</span><br><span class="line"><span class="comment"># 查看暴露在外部的端口</span></span><br><span class="line">kubectl get service/nginx-service</span><br></pre></td></tr></table></figure>

<p><img src="/2023/06/04/ubuntu%E9%83%A8%E7%BD%B2kubernetes%E4%B8%8Eceph%E9%9B%86%E6%88%90/image-20230605202752426.png" alt="image-20230605202752426"></p>
<p><img src="/2023/06/04/ubuntu%E9%83%A8%E7%BD%B2kubernetes%E4%B8%8Eceph%E9%9B%86%E6%88%90/image-20230605202734289.png" alt="image-20230605202734289"></p>
<h3 id="七-k8s前端部署-（默认没有部署为可选值）"><a href="#七-k8s前端部署-（默认没有部署为可选值）" class="headerlink" title="七. k8s前端部署 （默认没有部署为可选值）"></a>七. <code>k8s</code>前端部署 （默认没有部署为可选值）</h3><p>参考：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/265992210">https://zhuanlan.zhihu.com/p/265992210</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="八-k8s与ceph集成"><a href="#八-k8s与ceph集成" class="headerlink" title="八. k8s与ceph集成"></a>八. <code>k8s</code>与<code>ceph</code>集成</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

</div>
        </div>
        
            <div class="kratos-copyright text-center clearfix">
                <h5 itemprop="copyrightNotice">本作品采用 <a rel="license nofollow" target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">知识共享署名-相同方式共享 4.0 国际许可协议</a> 进行许可</h5>
            </div>
        
        <footer class="kratos-entry-footer clearfix">
            
                <div class="post-like-donate text-center clearfix" id="post-like-donate">
                
                    <a class="donate" href="javascript:;"><i class="fa fa-bitcoin"></i> 打赏</a>
                
                
                    <a class="share" href="javascript:;"><i class="fa fa-share-alt"></i> 分享</a>
                    <div class="share-wrap" style="display: none;">
    <div class="share-group">
        <a href="javascript:;" class="share-plain qq" onclick="share('qq');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-qq"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain qzone" onclick="share('qzone');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-star"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain weixin pop style-plain" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-weixin"></i>
            </div>
            <div class="share-int">
                <div class="qrcode" id="wechat-qr"></div>
                <p>打开微信“扫一扫”，打开网页后点击屏幕右上角分享按钮</p>
            </div>
        </a>
        <a href="javascript:;" class="share-plain weibo" onclick="share('weibo');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-weibo"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain facebook style-plain" onclick="share('facebook');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-facebook"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain twitter style-plain" onclick="share('twitter');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-twitter"></i>
            </div>
        </a>
    </div>
    <script type="text/javascript">
        $(()=>{
            new QRCode("wechat-qr", {
                text: "https://gegewu12.github.io/2023/06/04/ubuntu%E9%83%A8%E7%BD%B2kubernetes%E4%B8%8Eceph%E9%9B%86%E6%88%90/",
                width: 150,
                height: 150,
                correctLevel : QRCode.CorrectLevel.H
            });
        });
        function share(dest) {
            const qqBase        = "https://connect.qq.com/widget/shareqq/index.html?";
            const weiboBase     = "https://service.weibo.com/share/share.php?";
            const qzoneBase     = "https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?";
            const facebookBase  = "https://www.facebook.com/sharer/sharer.php?";
            const twitterBase   = "https://twitter.com/intent/tweet?";
            const hostUrl       = "https://gegewu12.github.io/2023/06/04/ubuntu%E9%83%A8%E7%BD%B2kubernetes%E4%B8%8Eceph%E9%9B%86%E6%88%90/";
            const title         = "「ubuntu部署kubernetes与ceph集成」";
            const excerpt       = `ubuntu部署kubernetes与ceph集成主要参考：https://skyao.io/learning-kubernetes/docs/installation/kubeadm/ubuntu.htmlhttps://www.c...`;
            let _URL;
            switch (dest) {
                case "qq"       : _URL = qqBase+"url="+hostUrl+"&title="+title+"&desc=&summary="+excerpt+"&site=cxpy";     break;
                case "weibo"    : _URL = weiboBase+"url="+hostUrl+"&title="+title+excerpt;                                 break;
                case "qzone"    : _URL = qzoneBase+"url="+hostUrl+"&title="+title+"&desc=&summary="+excerpt+"&site=cxpy";  break;
                case "facebook" : _URL = facebookBase+"u="+hostUrl;                                                        break;
                case "twitter"  : _URL = twitterBase+"text="+title+excerpt+"&url="+hostUrl;                                break;
            }
            window.open(_URL);
        };
    </script>
</div>
                
                </div>
            
            <div class="footer-tag clearfix">
                <div class="pull-left">
                <i class="fa fa-tags"></i>
                    <a class="tag-none-link" href="/tags/ceph/" rel="tag">ceph</a>, <a class="tag-none-link" href="/tags/kubernetes/" rel="tag">kubernetes</a>, <a class="tag-none-link" href="/tags/ubuntu/" rel="tag">ubuntu</a>
                </div>
                <div class="pull-date">
                    <time datetime="2023-06-05T13:13:44.729Z" itemprop="dateModified">最后编辑：2023-06-05</time>
                </div>
            </div>
        </footer>
    </div>
    
        <nav class="navigation post-navigation clearfix" role="navigation">
            
            <div class="nav-previous clearfix">
                <a title=" ubuntu部署ceph-n版" href="/2023/06/03/ubuntu部署ceph-n版/">&lt; 上一篇</a>
            </div>
            
            
            <div class="nav-next clearfix">
                <a title=" 使用terraform管理openstack" href="/2023/06/05/使用terraform管理openstack/">下一篇 &gt;</a>
            </div>
            
        </nav>
    
    
        <div id="v-comments" class="post-comments bg-image"></div>
<script>
    var load_comm = () => {
        const init = () => {
            new Valine({
                el: '#v-comments',
                appId: 'j2rHZR7PYdL07dtteIjU2I6p-9Nh9j0Va',
                appKey: 'QGQtOyQ3KRl2gUnQAESqz6Nc',
                visitor: true,
                enableQQ: true,
                path: '/2023/06/04/ubuntu%E9%83%A8%E7%BD%B2kubernetes%E4%B8%8Eceph%E9%9B%86%E6%88%90/'
            });
        }
        if (typeof Valine === 'undefined') {
            const src = '/vendors/valine@1.4.18/dist/Valine.min.js';
            $.getScript(src, init);
        } else {
            init();
        }
    };
</script>
<noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="https://valine.js.org/">comments powered by Valine.</a></noscript>

    
</article>

        

            </section>

        

                
            

<section id="kratos-widget-area" class="col-md-4 hidden-xs hidden-sm">
    <!-- 文章和页面根据splitter来分割，没有的话就从头开始设置为sticky -->
    
    
                <aside id="krw-about" class="widget widget-kratos-about clearfix">
    <div class="photo-background"></div>
    <div class="photo-wrapper clearfix">
        <div class="photo-wrapper-tip text-center">
            <img class="about-photo" src="/images/avatar.webp" loading="lazy" decoding="auto" />
        </div>
    </div>
    <div class="textwidget">
        <p class="text-center">众里寻他千百度，蓦然回首，那人却在，灯火阑珊处。</p>
    </div>
    <div class="site-meta">
        <a class="meta-item" href="/archives/">
            <span class="title">
                文章
            </span>
            <span class="count">
                63
            </span>
        </a>
        <a class="meta-item" href="/categories/">
            <span class="title">
                分类
            </span>
            <span class="count">
                14
            </span>
        </a>
        <a class="meta-item" href="/tags/">
            <span class="title">
                标签
            </span>
            <span class="count">
                15
            </span>
        </a>
    </div>
</aside>
            
                    <div class="sticky-area">
                
                    <aside id="krw-toc" class="widget widget-kratos-toc clearfix toc-div-class" >
    <div class="photo-background"></div>
    <h4 class="widget-title no-after">
        <i class="fa fa-compass"></i>
        文章目录
        <span class="toc-progress-bar" role="progressbar" aria-label="阅读进度："></span>
    </h4>
    <div class="textwidget">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#ubuntu%E9%83%A8%E7%BD%B2kubernetes%E4%B8%8Eceph%E9%9B%86%E6%88%90"><span class="toc-text">ubuntu部署kubernetes与ceph集成</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-text">一. 环境准备</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%85%88%E9%83%A8%E7%BD%B2%E5%A5%BDceph"><span class="toc-text">1.  先部署好ceph</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-ubuntu%E6%8D%A2%E9%98%BF%E9%87%8C%E4%BA%91kubernetes%E6%BA%90-%E5%AE%89%E8%A3%85k8s%E9%83%A8%E7%BD%B2%E5%B7%A5%E5%85%B7-%EF%BC%88%E6%AD%A4%E6%AD%A5%E9%AA%A4%E6%AD%A4%E5%A4%84%E4%B8%8D%E5%81%9A%EF%BC%89"><span class="toc-text">2. ubuntu换阿里云kubernetes源 安装k8s部署工具 （此步骤此处不做）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%B8%B8%E8%A7%84%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%EF%BC%88%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E6%89%A7%E8%A1%8C%EF%BC%89"><span class="toc-text">3. 常规环境配置（所有节点执行）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E5%AE%89%E8%A3%85-docker-containerd-%EF%BC%88-%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9-%EF%BC%89"><span class="toc-text">4.安装 docker containerd （ 所有节点 ）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E5%AE%89%E8%A3%85docker-ce"><span class="toc-text">5.安装docker-ce</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-%E5%AE%89%E8%A3%85containerd-%E6%AD%A4%E5%A4%84%E5%8F%AF%E4%B8%8D%E6%89%A7%E8%A1%8C%E5%8E%9F%E5%9B%A0%E4%BD%8E%E7%89%88%E6%9C%AC%E4%BB%8D%E7%94%A8docker"><span class="toc-text">6.安装containerd ( 此处可不执行原因低版本仍用docker )</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-%E5%AE%89%E8%A3%85Kubernetes%E7%BB%84%E4%BB%B6-%EF%BC%88-%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9-%EF%BC%89"><span class="toc-text">7. 安装Kubernetes组件 （ 所有节点 ）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C-%E5%88%9D%E5%A7%8B%E5%8C%96Master-ceph1-%E8%8A%82%E7%82%B9-%EF%BC%88-%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E5%BB%BA%E8%AE%AE%E4%BD%BF%E7%94%A82-%EF%BC%89"><span class="toc-text">二. 初始化Master(ceph1)节点 （ 所有节点建议使用2 ）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E4%BD%BF%E7%94%A8%E8%84%9A%E6%9C%AC%E6%8B%89%E5%8F%96%E5%90%8E%E5%86%8D%E6%AC%A1%E6%89%A7%E8%A1%8C%E5%88%9D%E5%A7%8B%E5%8C%96%E9%9B%86%E7%BE%A4"><span class="toc-text">1.使用脚本拉取后再次执行初始化集群</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%88%9D%E5%A7%8B%E5%8C%96%E9%9B%86%E7%BE%A4-%EF%BC%88%E9%83%A8%E7%BD%B2%E8%8A%82%E7%82%B9ceph1%E6%89%A7%E8%A1%8C%EF%BC%89%E7%9B%B4%E6%8E%A5%E6%8C%87%E5%AE%9A%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93%E5%88%9D%E5%A7%8B%E5%8C%96%E9%9B%86%E7%BE%A4"><span class="toc-text">2.初始化集群 （部署节点ceph1执行）直接指定镜像仓库初始化集群</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%85%B3%E4%BA%8E%E6%8A%A5%E9%94%99%E8%B6%85%E6%97%B6"><span class="toc-text">3.关于报错超时</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E6%8C%89%E7%85%A7%E6%8F%90%E7%A4%BA%E4%BF%A1%E6%81%AF%E7%BB%A7%E7%BB%AD%E5%88%9D%E5%A7%8B%E5%8C%96-ceph-1"><span class="toc-text">4.按照提示信息继续初始化(ceph-1)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89-%E6%B7%BB%E5%8A%A0%E5%85%B6%E4%BB%96%E8%8A%82%E7%82%B9"><span class="toc-text">三. 添加其他节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B-%E5%AE%89%E8%A3%85%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6-ceph-1"><span class="toc-text">四. 安装网络插件(ceph-1)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E9%87%87%E2%BD%A4flannel%E7%9A%84%E2%BD%B9%E7%BB%9C%E6%8F%92%E4%BB%B6"><span class="toc-text">1.采⽤flannel的⽹络插件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%AE%89%E8%A3%85flannel%E6%8F%92%E4%BB%B6%EF%BC%88node-1%EF%BC%89"><span class="toc-text">2.安装flannel插件（node-1）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E9%83%A8%E7%BD%B2%E9%9C%80%E8%A6%81%E6%8B%89%E5%8F%96%E9%95%9C%E5%83%8F%EF%BC%8C%E9%9C%80%E8%A6%81%E7%82%B9%E6%97%B6%E9%97%B4%EF%BC%8C%E5%8F%AF%E4%BB%A5%E6%9F%A5%E7%9C%8Bflannel%E9%83%A8%E7%BD%B2%E7%9A%84%E6%83%85%E5%86%B5"><span class="toc-text">3.部署需要拉取镜像，需要点时间，可以查看flannel部署的情况</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E9%83%A8%E7%BD%B2cni"><span class="toc-text">4.所有节点部署cni</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94-%E9%AA%8C%E8%AF%81%E9%9B%86%E7%BE%A4"><span class="toc-text">五. 验证集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94-%E5%8F%91%E5%B8%83%E7%AE%80%E5%8D%95nginx%E5%BA%94%E7%94%A8"><span class="toc-text">五.  发布简单nginx应用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AD-%E5%8F%91%E5%B8%83%E5%AE%9E%E7%8E%B0%E5%A4%96%E9%83%A8%E8%AE%BF%E9%97%AEnginx%E5%BA%94%E7%94%A8"><span class="toc-text">六. 发布实现外部访问nginx应用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%83-k8s%E5%89%8D%E7%AB%AF%E9%83%A8%E7%BD%B2-%EF%BC%88%E9%BB%98%E8%AE%A4%E6%B2%A1%E6%9C%89%E9%83%A8%E7%BD%B2%E4%B8%BA%E5%8F%AF%E9%80%89%E5%80%BC%EF%BC%89"><span class="toc-text">七. k8s前端部署 （默认没有部署为可选值）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AB-k8s%E4%B8%8Eceph%E9%9B%86%E6%88%90"><span class="toc-text">八. k8s与ceph集成</span></a></li></ol></li></ol>
    </div>
</aside>
                
                
  <aside id="krw-categories" class="widget widget-kratos-categories clearfix">
    <h4 class="widget-title"><i class="fa fa-folder"></i>分类目录</h4>
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/centos/">centos</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ceph/">ceph</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/club/">club</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/kubernetes/">kubernetes</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/py/">py</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/shell/">shell</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ubuntu/">ubuntu</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F%E7%9B%91%E6%8E%A7/">云原生监控</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BA%91%E8%AE%A1%E7%AE%97/">云计算</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B8%B8%E7%94%A8%E8%BD%AF%E4%BB%B6/">常用软件</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2/">环境部署</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%81%E4%BA%91/">迁云</a><span class="category-list-count">2</span></li></ul>
  </aside>


            
                
  <aside id="krw-tags" class="widget widget-kratos-tags clearfix">
    <h4 class="widget-title"><i class="fa fa-tags"></i>标签聚合</h4>
      <div class="tag-clouds">
        <a href="/tags/centos/" style="font-size: 0.7em;">centos</a> <a href="/tags/ceph/" style="font-size: 0.63em;">ceph</a> <a href="/tags/change-cloub/" style="font-size: 0.6em;">change-cloub</a> <a href="/tags/club/" style="font-size: 0.7em;">club</a> <a href="/tags/docker/" style="font-size: 0.73em;">docker</a> <a href="/tags/kubernetes/" style="font-size: 0.6em;">kubernetes</a> <a href="/tags/mysql/" style="font-size: 0.7em;">mysql</a> <a href="/tags/python/" style="font-size: 0.65em;">python</a> <a href="/tags/shell/" style="font-size: 0.68em;">shell</a> <a href="/tags/ubuntu/" style="font-size: 0.73em;">ubuntu</a> <a href="/tags/%E4%BA%91%E5%8E%9F%E7%94%9F%E7%9B%91%E6%8E%A7/" style="font-size: 0.75em;">云原生监控</a> <a href="/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/" style="font-size: 0.78em;">云计算</a> <a href="/tags/%E5%B8%B8%E7%94%A8%E8%BD%AF%E4%BB%B6/" style="font-size: 0.8em;">常用软件</a> <a href="/tags/%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2/" style="font-size: 0.8em;">环境部署</a> <a href="/tags/%E8%BF%81%E4%BA%91/" style="font-size: 0.6em;">迁云</a>
      </div>
  </aside>

            
                
  <aside id="krw-posts" class="widget widget-kratos-posts">
  <h4 class="widget-title"><i class="fa fa-file"></i>最新文章</h4>
  <div class="tab-content">
      <ul class="list-group">
        
        
          
          
            <a class="list-group-item" href="/2023/06/05/hello-world/"><i class="fa  fa-book"></i> Hello World</a>
            
          
        
          
          
            <a class="list-group-item" href="/2023/06/05/butterfly%E4%B8%BB%E9%A2%98%E8%AE%BE%E7%BD%AE/"><i class="fa  fa-book"></i> butterfly主题设置</a>
            
          
        
          
          
            <a class="list-group-item" href="/2023/06/05/%E4%BD%BF%E7%94%A8terraform%E7%AE%A1%E7%90%86openstack/"><i class="fa  fa-book"></i> 使用terraform管理openstack</a>
            
          
        
          
          
            <a class="list-group-item" href="/2023/06/04/ubuntu%E9%83%A8%E7%BD%B2kubernetes%E4%B8%8Eceph%E9%9B%86%E6%88%90/"><i class="fa  fa-book"></i> ubuntu部署kubernetes与ceph集成</a>
            
          
        
          
          
            <a class="list-group-item" href="/2023/06/03/ubuntu%E9%83%A8%E7%BD%B2ceph-n%E7%89%88/"><i class="fa  fa-book"></i> ubuntu部署ceph-n版</a>
            
          
        
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
      </ul>
  </div>
  </aside>

            
    </div>
</section>
        
        </div>
    </div>
</div>
<footer>
    <div id="footer"  class="ap-lrc"  >
        <div class="container">
            <div class="row">
                <div class="col-md-6 col-md-offset-3 footer-list text-center">
                    <ul class="kratos-social-icons">
                        <!-- Keep for compatibility -->
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <!-- New links -->
                        
                    </ul>
                    <ul class="kratos-copyright">
                        <div>
                            <li>&copy; 2023 zznn 版权所有.</li>
                            <li>本站已运行<span id="span_dt">Loading...</span></li>
                        </div>
                        <div>
                            <li>Theme <a href="https://github.com/Candinya/Kratos-Rebirth" target="_blank">Kratos:Rebirth</a></li>
                            <li>Site built with&nbsp;<i class="fa fa-heart throb" style="color:#d43f57"></i>&nbsp;by zznn.</li>
                        </div>
                        <div>
                            <li>Powered by <a href="https://hexo.io" target="_blank" rel="nofollow">Hexo</a></li>
                            <li>Hosted on <a href="https://github.io" target="_blank">Github Pages</a></li>
                        </div>
                        <div>
                            
                            
                        </div>
                    </ul>
                </div>
            </div>
        </div>
        <div class="kr-tool text-center">
            <div class="tool">
                
                    <div class="box search-box">
                        <a href="/search/">
                            <span class="fa fa-search"></span>
                        </a>
                    </div>
                
                
                    <div class="box theme-box" id="darkmode-switch">
                        <span class="fa fa-adjust"></span>
                    </div>
                
                
                
            </div>
            <div class="box gotop-box">
                <span class="fa fa-chevron-up"></span>
            </div>
        </div>
    </div>
</footer>
</div>
</div>

        <script defer src="/vendors/bootstrap@3.3.4/dist/js/bootstrap.min.js"></script>
<script defer src="/vendors/nprogress@0.2.0/nprogress.js"></script>
<script>
    if (!window.kr) {
        window.kr = {};
    }
    window.kr.notMobile = (!(navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i)));
    window.kr.siteRoot = "/";
</script>


    <script async src="/js/candy.min.js"></script>



    <script defer src="/vendors/aplayer@1.10.1/dist/APlayer.min.js"></script>
    
    <script defer src="/vendors/meting@2.0.1/dist/Meting.min.js"></script>
    <meting-js
        server="netease"
        type="playlist"
        id="8456378003"
        order="random"
        fixed="true"
    >
    </meting-js>



    <script defer src="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>

<script defer src="/js/kratosr.min.js"></script>
<script defer src="/js/pjax.min.js"></script>

    <script defer src="/vendors/layui-src@2.5.5/dist/layui.all.js"></script>



<!-- Extra support for third-party plguins  -->


    </body>
</html>